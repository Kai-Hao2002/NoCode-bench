# render.yaml

services:
  # 1. PostgreSQL è³‡æ–™åº«
  # (PostgreSQL Database)
  - type: postgres
    name: nocode-db
    plan: free # æ³¨æ„ï¼šå…è²»æ–¹æ¡ˆ 90 å¤©å¾ŒéæœŸ
              # (Note: Free plan expires after 90 days)
    
  # 2. Redis ä½‡åˆ—
  # (Redis Queue)
  - type: redis
    name: nocode-redis
    plan: free

  # 3. Django Web ä¼ºæœå™¨ (Gunicorn)
  # (Django Web Server (Gunicorn))
  - type: web
    name: app
    plan: free
    runtime: docker # å‘Šè¨´ Render ä½¿ç”¨æ‚¨çš„ Dockerfile
                    # (Tells Render to use your Dockerfile)
    dockerfilePath: ./Dockerfile
    healthCheckPath: /admin/login/
    command: gunicorn nocode_project.wsgi:application
    envVars:
      - key: DEBUG
        value: False
      - key: SECRET_KEY
        sync: false # æˆ‘å€‘å°‡åœ¨ Render UI ä¸­æ‰‹å‹•è¨­ç½®
                    # (We will set this manually in the Render UI)
      - key: GEMINI_API_KEY
        sync: false # æˆ‘å€‘å°‡åœ¨ Render UI ä¸­æ‰‹å‹•è¨­ç½®
                    # (We will set this manually in the Render UI)
      - key: ALLOWED_HOSTS
        value: localhost,127.0.0.1 # settings.py æœƒè‡ªå‹•æ·»åŠ  .onrender.com
                                   # (settings.py will add .onrender.com automatically)
      # å¾å…¶ä»–æœå‹™è‡ªå‹•é€£æ¥
      # (Auto-connect from other services)
      - key: DATABASE_URL
        fromService:
          type: postgres
          name: nocode-db
          property: internalDatabaseUrl
      - key: REDIS_URL
        fromService:
          type: redis
          name: nocode-redis
          property: internalConnectionUrl
    autoDeploy: false # æ¨è–¦æ‰‹å‹•éƒ¨ç½²
                      # (Recommend manual deploys)
    # ğŸš€ åˆå§‹éƒ¨ç½²æ™‚é‹è¡Œçš„å‘½ä»¤
    # (Commands to run on initial deploy)
    initialDeployHook: |
      python manage.py migrate
      python manage.py load_benchmark_data

  # 4. Celery Worker (æ‚¨çš„ AI Agent)
  # (Celery Worker (Your AI Agent))
  - type: worker
    name: worker
    plan: free
    runtime: docker # é‡ç”¨åŒä¸€å€‹ Dockerfile
                    # (Reuse the same Dockerfile)
    dockerfilePath: ./Dockerfile
    command: celery -A nocode_project worker --loglevel=info -P gevent --concurrency=1
    envVars:
      - key: DEBUG
        value: False
      - key: SECRET_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: ALLOWED_HOSTS
        value: localhost,127.0.0.1
      - key: DATABASE_URL
        fromService:
          type: postgres
          name: nocode-db
          property: internalDatabaseUrl
      - key: REDIS_URL
        fromService:
          type: redis
          name: nocode-redis
          property: internalConnectionUrl
    autoDeploy: false
    # ğŸš€ æ›è¼‰æŒä¹…ç£ç¢Ÿ
    # (Mount the persistent disk)
    disks:
      - name: nocode-workspaces-disk
        mountPath: /app/nocode_workspaces
        sizeGB: 1