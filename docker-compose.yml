# docker-compose.yml
version: '3.8'

services:
  
  # 1. PostgreSQL è³‡æ–™åº«
  db:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    # ğŸš€ å¾ .env æ–‡ä»¶ä¸­è®€å– Postgres çš„æ†‘è­‰
    # (Read Postgres credentials from .env file)
    env_file:
      - ./.env
    restart: always

  # 2. Redis ä½‡åˆ—
  redis:
    image: redis:7
    restart: always

  # 3. Django Web ä¼ºæœå™¨ (Gunicorn)
  app:
    build: .
    command: gunicorn nocode_project.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    expose:
      - 8000
    restart: always
    env_file:
      - ./.env
    depends_on:
      - db
      - redis

  # 4. Celery Worker (æ‚¨çš„ AI Agent)
  worker:
    build: .
    command: celery -A nocode_project worker --loglevel=info -P gevent --concurrency=1
    volumes:
      # ğŸš€ é—œéµï¼å°‡å·¥ä½œå€æ›è¼‰ç‚ºæŒä¹…å·
      # (CRITICAL! Mount the workspace as a persistent volume)
      - nocode_workspaces:/app/nocode_workspaces
    restart: always
    env_file:
      - ./.env
    depends_on:
      - app
      - db
      - redis
  
  # 5. Nginx (åå‘ä»£ç†)
  nginx:
    image: nginx:latest
    ports:
      - "80:80" # å°‡ä¼ºæœå™¨çš„ 80 ç«¯å£æ˜ å°„åˆ° Nginx
                # (Map server port 80 to Nginx)
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - static_volume:/app/staticfiles:ro
      - media_volume:/app/media:ro
    depends_on:
      - app
    restart: always

# é ‚å±¤å·å®šç¾© (Top-level volume definitions)
volumes:
  postgres_data:
  static_volume:
  media_volume:
  nocode_workspaces: # ğŸš€ ç¢ºä¿é€™å€‹æŒä¹…å·å­˜åœ¨
                     # (Ensure this persistent volume exists)